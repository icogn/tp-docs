<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-technical-explanations/texture-recoloring">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Texture Recoloring | TP Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://icogn.github.io/tp-docs/docs/technical-explanations/texture-recoloring"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Texture Recoloring | TP Docs"><meta data-rh="true" name="description" content="This page explains how texture recoloring can be done without modifying the ROM."><meta data-rh="true" property="og:description" content="This page explains how texture recoloring can be done without modifying the ROM."><link data-rh="true" rel="icon" href="/tp-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://icogn.github.io/tp-docs/docs/technical-explanations/texture-recoloring"><link data-rh="true" rel="alternate" href="https://icogn.github.io/tp-docs/docs/technical-explanations/texture-recoloring" hreflang="en"><link data-rh="true" rel="alternate" href="https://icogn.github.io/tp-docs/docs/technical-explanations/texture-recoloring" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/tp-docs/blog/rss.xml" title="TP Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tp-docs/blog/atom.xml" title="TP Docs Atom Feed"><link rel="stylesheet" href="/tp-docs/assets/css/styles.7afa8f30.css">
<link rel="preload" href="/tp-docs/assets/js/runtime~main.adbb371e.js" as="script">
<link rel="preload" href="/tp-docs/assets/js/main.789a4f82.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tp-docs/"><div class="navbar__logo"><img src="/tp-docs/img/logo.svg" alt="TP Docs Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/tp-docs/img/logo.svg" alt="TP Docs Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TP Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/icogn/tp-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/ostickstocalendartime">OSTicksToCalendarTime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seed-file-thoughts">Rando Seed File Thoughts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seed-versioning">Rando Seed Versioning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal">Rando SeedInfo ARCP Structure Proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seedInfo-clr0">Rando SeedInfo CLR0 Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/sprlocksoftlock">Snowpeak Ruins Lock Softlock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/tp-docs/docs/technical-explanations/texture-recoloring">Texture Recoloring</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/tp-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Texture Recoloring</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Texture Recoloring</h1><p>This page explains how texture recoloring can be done without modifying the ROM.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="demo">Demo<a class="hash-link" href="#demo" title="Direct link to heading">â€‹</a></h2><p>You can adjust the color picker to see the texture get recolored.</p><div class="root_yWrC"><div class="rcp rcp-dark" style="width:300px"><div class="rcp-saturation" style="height:150px;background-color:hsl(100.97560975609757, 100%, 50%)"><div class="rcp-saturation-cursor" style="left:91.11111111111109px;top:70.58823529411764px;background-color:#6b875e"></div></div><div class="rcp-body"><div class="rcp-hue"><div class="rcp-hue-cursor" style="left:72.92682926829269px;background-color:hsl(100.97560975609757, 100%, 50%)"></div></div><div class="rcp-fields"><div class="rcp-fields-element hex-element"><input class="rcp-fields-element-input" value="#6b875e"><label class="rcp-fields-element-label">HEX</label></div></div></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The above is just for demonstration purposes.
The exact color you see in the game depends on the lighting of the area, so the only real way to see how a color looks in the game is to see the color in the game.
I may publish something to make this easier to accomplish at some point.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="colors">Colors<a class="hash-link" href="#colors" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re just going to focus on the color and texture parts of the recoloring.
Where to hook, how to locate which bytes to change, etc. are out of the scope of this document.</p><p>Recoloring an image is essentially a two-step process:</p><ol><li>Desaturate the image.</li><li>Blend the image with a color.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="desaturation">Desaturation<a class="hash-link" href="#desaturation" title="Direct link to heading">â€‹</a></h3><p>There are many ways to desaturate a color.</p><p>We use a quick but effective method of desaturation:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">grayValue = 0.22 * r + 0.72 * g + 0.06 * b;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We make use of multiplication and shifts to make this calculation very fast.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blending">Blending<a class="hash-link" href="#blending" title="Direct link to heading">â€‹</a></h3><p>There are many ways to blend colors.</p><p>The algorithm we use is known as an &quot;Overlay&quot; blend.</p><p>This algorithm was chosen because when you use a color like 0xFF0000 (red), the result is probably way too red for most people.
This is a good thing though, because it means we do not wind up in a situation where people are left wanting more.
If the extremes are extreme, then that means any reasonable values that someone might want should be available somewhere in the middle.</p><p>The blend algorithm is as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">f(a,b) = 2ab, if a &lt; 0.5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f(a,b) = 1 - 2(1 - a)(1 - b), otherwise</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We make use of multiplication and shifts to speed this calculation up as well, so it is not as slow as it might look.</p><p>Additionally, since we are only ever converting a gray value (0 through 255) to an RGB value, we can run the blend once for every possible gray value up-front.
Then as we iterate through the texture, if we need to blend 0x78 (a gray value) with the rgb for example, we can use the cached value.
This means we only need to execute the blend a maximum of 256 times no matter how large the texture we are recoloring is.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="textures">Textures<a class="hash-link" href="#textures" title="Direct link to heading">â€‹</a></h2><p>The model textures we are currently recoloring are all the same format known as CMPR, so we will discuss the details of this since it can be a little confusing.</p><p>We&#x27;ll ignore most of the details since they aren&#x27;t really important and focus on the changes that happen as they relate to the RGB values.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cmpr-format">CMPR format<a class="hash-link" href="#cmpr-format" title="Direct link to heading">â€‹</a></h3><p>The CMPR format can encode the colors for 16 pixels using only 8 bytes of data.</p><p>This is pretty impressive since if you were to simply use 3 bytes (R,G,B) for each pixel, this would take 48 bytes (6 times as much space).</p><p>Each 8 byte chunk can be split up as follows:</p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>0x00</td><td>u16</td><td>leftColor</td><td>RGB565 value</td></tr><tr><td>0x02</td><td>u16</td><td>rightColor</td><td>RGB565 value</td></tr><tr><td>0x04</td><td>u32</td><td>paletteBits</td><td>16 entries which are 2 bits each.</td></tr></tbody></table><p>The 16 entries each point to either the leftColor, the rightColor, or a derived palette entry.</p><p>The derived palette is based on the numerical relationship between the leftColor and the rightColor.</p><p>If <code>leftColor &gt; rightColor</code> (comparing them as <code>uint16_t</code>), then the palette is:</p><table><thead><tr><th>bits</th><th>Palette Entry</th></tr></thead><tbody><tr><td>00</td><td>leftColor</td></tr><tr><td>01</td><td>rightColor</td></tr><tr><td>10</td><td>2/3 left and 1/3 right</td></tr><tr><td>11</td><td>1/3 left and 2/3 right</td></tr></tbody></table><p>otherwise (meaning <code>leftColor &lt;= rightColor</code>):</p><table><thead><tr><th>bits</th><th>Palette Entry</th></tr></thead><tbody><tr><td>00</td><td>leftColor</td></tr><tr><td>01</td><td>rightColor</td></tr><tr><td>10</td><td>1/2 left and 1/2 right</td></tr><tr><td>11</td><td>transparent</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rgb565">RGB565<a class="hash-link" href="#rgb565" title="Direct link to heading">â€‹</a></h3><p>You could say 8 bits of red, then 8 bits of green, then 8 bits of blue might be RGB888.</p><p>In this way, RGB565 is 5 bits of red, then 6 bits of green, then 5 bits of blue.</p><p>Pushing these up next to each other makes 16 bits to represent an RGB value.</p><p>The <code>leftColor</code> and <code>rightColor</code> in the CMPR format are each RGB565 values.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-recolor-cmpr">How to recolor CMPR<a class="hash-link" href="#how-to-recolor-cmpr" title="Direct link to heading">â€‹</a></h3><p>We can desaturate, blend, then store the result for the <code>leftColor</code> and the <code>rightColor</code>.</p><p>The main thing we have to take into consideration is that we need to handle the relative values of the left and right colors.</p><p>For example, if L was greater than R before the blend, but afterward they are equal, then we will run into some problems.
This is because the derived palette will now be different, so whereas bits <code>11</code> previously meant <code>1/3 left and 2/3 right</code>, it now means <code>transparent</code>.</p><p>We can&#x27;t be having transparency when there shouldn&#x27;t be any!</p><hr><p>After the blends, we will have 2 new colors.</p><p>If the relative values of them are the same as before the blend, then we can just store them and move on.</p><p>We need to make sure we handle some edge cases otherwise, and here is what the code for that looks like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if ( leftIsGreater )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if ( leftNewRgb565 == rightNewRgb565 )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Need to make sure that subtracting 1 does not mess</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // everything up. For example, 0x1000 - 1 =&gt; 0x0fff which is</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // a completely different color.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( ( leftNewRgb565 &amp; 0x1f ) == 0 )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // If left value has 0 blue, we change its blue to 1.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            leftNewRgb565 += 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        rightNewRgb565 = leftNewRgb565 - 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else if ( leftNewRgb565 &lt; rightNewRgb565 )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        needsBitSwap = true;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">else if ( leftNewRgb565 &gt; rightNewRgb565 )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    needsBitSwap = true;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So if &quot;left was greater and now right is greater&quot; or if &quot;right was greater and now left is greater&quot;, we need to update the palette bits to point to the correct palette entry (the <code>needsBitSwap</code> parts).</p><p>In the specific case that &quot;left was greater, but now they are equal&quot;, we actually have to modify the left one to still be greater.
If we didn&#x27;t do this, we would get some transparency in the palette when there shouldn&#x27;t be any.</p><p>To fix this, we set the right to be one less than the left.</p><p>There is an additional edge-case within the edge-case in which subtracting 1 from the new leftColor would cause problems if the leftColor had 0 blue.</p><p>For example, if both of the new colors were 0x1000, when we subtract 1 from the right one, we would get 0xfff.
This is a completely different color which actually has maximum blue!</p><p>So in the case that the blue of the leftColor is 0, we set it to be 1 in the leftColor and 0 in the rightColor.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bit-swapping">Bit-swapping<a class="hash-link" href="#bit-swapping" title="Direct link to heading">â€‹</a></h4><p>For the cases that we need to update the palette bits, we use the following:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// In the case of left being greater than right:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b00 will swap to 0b01</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b01 will swap to 0b00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b10 will swap to 0b11</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b11 will swap to 0b10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// So the left bit stays the same, and the right bit changes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Can do xor (^) like 0b01010101 or 0x55 for each u16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// In the case of left not being greater than right:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b00 will swap to 0b01</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b01 will swap to 0b00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b10 will stay the same</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 0b11 will stay the same</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// so if the left bit is a 0, the right bit will change</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">uint32_t swapIndexBits( bool leftIsGreater, uint32_t bits )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if ( leftIsGreater )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return bits ^ 0x55555555;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t mask = ( ( bits &gt;&gt; 1 ) &amp; 0x55555555 ) ^ 0x55555555;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return bits ^ mask;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Humans perceive blue less than red and green, so that is why we make modifications to the blue when we handle the &quot;left was greater, but the new ones are equal&quot; edge-case.
This is also why blue has the smallest coefficient in the desaturate function.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other">Other<a class="hash-link" href="#other" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="partial-texture-recoloring">Partial texture recoloring<a class="hash-link" href="#partial-texture-recoloring" title="Direct link to heading">â€‹</a></h3><p>You can also use a callback function to only conditionally recolor parts of the texture.
This is needed for something like the Hylian Shield which is a large number of colors.</p><p>You can do a pretty decent job of recoloring just the bird on the shield.
But this kind of thing has to be handled case-by-case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a class="hash-link" href="#limitations" title="Direct link to heading">â€‹</a></h3><p>This is mainly meant to work with colors on 3D models, but even then some things are handled differently, so you will still have to solve for each thing based on research findings.</p><p>This has only been written to support updating CMPR textures, but you could theoretically handled other formats as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fancy-stuff">Fancy stuff<a class="hash-link" href="#fancy-stuff" title="Direct link to heading">â€‹</a></h3><p>You could theoretically do gradients and whatnot as well, but the code for this would be more complicated.</p><p>Maybe worth looking into how MAT stuff works more to see what is possible there.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">â€‹</a></h2><ul><li><a href="https://tannerhelland.com/2011/10/01/grayscale-image-algorithm-vb6.html" target="_blank" rel="noopener noreferrer">Seven grayscale conversion algorithms (with pseudocode and VB6 source code)</a></li><li><a href="https://docs.gimp.org/2.10/en/gimp-filter-desaturate.html" target="_blank" rel="noopener noreferrer">GIMP - Desaturate</a></li><li><a href="https://en.wikipedia.org/wiki/Blend_modes#Overlay" target="_blank" rel="noopener noreferrer">Wikipedia - Blend modes</a></li><li><a href="https://wiki.tockdom.com/wiki/Image_Formats#CMPR" target="_blank" rel="noopener noreferrer">Custom Mario Kart Wiiki - Image Formats</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/icogn/tp-docs/edit/main/website/docs/technical-explanations/texture-recoloring.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tp-docs/docs/technical-explanations/sprlocksoftlock"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Snowpeak Ruins Lock Softlock</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#demo" class="table-of-contents__link toc-highlight">Demo</a></li><li><a href="#colors" class="table-of-contents__link toc-highlight">Colors</a><ul><li><a href="#desaturation" class="table-of-contents__link toc-highlight">Desaturation</a></li><li><a href="#blending" class="table-of-contents__link toc-highlight">Blending</a></li></ul></li><li><a href="#textures" class="table-of-contents__link toc-highlight">Textures</a><ul><li><a href="#cmpr-format" class="table-of-contents__link toc-highlight">CMPR format</a></li><li><a href="#rgb565" class="table-of-contents__link toc-highlight">RGB565</a></li><li><a href="#how-to-recolor-cmpr" class="table-of-contents__link toc-highlight">How to recolor CMPR</a></li></ul></li><li><a href="#other" class="table-of-contents__link toc-highlight">Other</a><ul><li><a href="#partial-texture-recoloring" class="table-of-contents__link toc-highlight">Partial texture recoloring</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a></li><li><a href="#fancy-stuff" class="table-of-contents__link toc-highlight">Fancy stuff</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 icogn</div></div></div></footer></div>
<script src="/tp-docs/assets/js/runtime~main.adbb371e.js"></script>
<script src="/tp-docs/assets/js/main.789a4f82.js"></script>
</body>
</html>