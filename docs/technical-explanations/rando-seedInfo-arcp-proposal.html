<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-technical-explanations/rando-seedInfo-arcp-proposal">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Rando SeedInfo ARCP Structure Proposal | TP Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://icogn.github.io/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Rando SeedInfo ARCP Structure Proposal | TP Docs"><meta data-rh="true" name="description" content="This page describes an alternative way of storing ARC patching instructions in a TPRando seed GCI."><meta data-rh="true" property="og:description" content="This page describes an alternative way of storing ARC patching instructions in a TPRando seed GCI."><link data-rh="true" rel="icon" href="/tp-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://icogn.github.io/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal"><link data-rh="true" rel="alternate" href="https://icogn.github.io/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal" hreflang="en"><link data-rh="true" rel="alternate" href="https://icogn.github.io/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/tp-docs/blog/rss.xml" title="TP Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tp-docs/blog/atom.xml" title="TP Docs Atom Feed"><link rel="stylesheet" href="/tp-docs/assets/css/styles.7afa8f30.css">
<link rel="preload" href="/tp-docs/assets/js/runtime~main.adbb371e.js" as="script">
<link rel="preload" href="/tp-docs/assets/js/main.789a4f82.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tp-docs/"><div class="navbar__logo"><img src="/tp-docs/img/logo.svg" alt="TP Docs Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/tp-docs/img/logo.svg" alt="TP Docs Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TP Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/icogn/tp-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/ostickstocalendartime">OSTicksToCalendarTime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seed-file-thoughts">Rando Seed File Thoughts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seed-versioning">Rando Seed Versioning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/tp-docs/docs/technical-explanations/rando-seedInfo-arcp-proposal">Rando SeedInfo ARCP Structure Proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/rando-seedInfo-clr0">Rando SeedInfo CLR0 Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/sprlocksoftlock">Snowpeak Ruins Lock Softlock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tp-docs/docs/technical-explanations/texture-recoloring">Texture Recoloring</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/tp-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Rando SeedInfo ARCP Structure Proposal</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Rando SeedInfo ARCP Structure Proposal</h1><p>This page describes an alternative way of storing ARC patching instructions in a TPRando seed GCI.</p><p><em>Note: You will see this section of the seed GCI referred to as the <code>ARCP</code> section (for arc patching).<br>
This naming is inspired by what you already see in the game files, such as <code>RARC</code>, <code>J3D2</code>, <code>BMDR</code>, etc.</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">â€‹</a></h2><p>A smaller GCI is generally more desirable than a large one, but the GCI&#x27;s block count is especially important for console players.</p><p>If a user is putting 10 seed GCIs on their memory card as advertised, increases in block size are multiplied by 10.</p><p>That is to say, an increase in block size from 3 to 4 is more like changing from 30 to 40.
Likewise, shaving off a block from the size is more like shaving off 10 blocks.</p><p>So it is reasonable to shave off blocks from the size if we are able to.</p><p><em>(This is why I think there should be an option to generate seed GCIs which leave out the image data.)</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="benefits">Benefits<a class="hash-link" href="#benefits" title="Direct link to heading">â€‹</a></h2><ul><li>With the current data of 332 patches (288 items and 44 message indexes), we cut the Arc Patch section of the seed GCI down to approximately 27% of its current size (from 0x2980 bytes to 0xB40).<ul><li>The will allow Seed GCIs to likely be reduced to a single block (not counting the imageData/comments block).</li></ul></li><li>Only do as many <code>my_DVDConvertPathToEntrynum</code> calls as absolutely necessary instead of one per patch.<ul><li>This goes from 332 calls to roughly 124.</li></ul></li><li>Instead of scanning through every patch every time you might want to apply one, simply scan by <code>entryNum</code> then immediately apply all patches once/if you find a match.</li><li>Supports patching arcs in ways more complex than simply 1, 2, or 4 bytes.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="trade-offs">Trade-offs<a class="hash-link" href="#trade-offs" title="Direct link to heading">â€‹</a></h3><ul><li>Need to generate the arc <code>entryNum</code> lookup table at runtime (only do this once).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="at-a-high-level">At a high level<a class="hash-link" href="#at-a-high-level" title="Direct link to heading">â€‹</a></h2><p>When &quot;arcA&quot; is loaded, we check if this arc needs to be patched.
If it does, we apply the appropriate patches.</p><p>This means that we need a list of arc identifiers, with each entry mapping to a list of patches to apply:</p><ul><li>arcsToPatch =&gt; <!-- -->[arcA, arcD, arcQ, arc7, arcC, arc2, ...]</li></ul><p>Within the list, each arc must map to a list of patches:</p><ul><li>arcA =&gt; <!-- -->[patch0, patch1, patch2, ...]</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The problem<a class="hash-link" href="#the-problem" title="Direct link to heading">â€‹</a></h3><p>This would be simple enough, but the problem is that we must wait until runtime to generate the arc identifiers.</p><p>For example:</p><ul><li>We want to patch <code>/res/Stage/D_MN10/R00_00.arc</code>.</li><li>At runtime, we are notified that arc <code>000005AC</code> was just loaded.</li><li>We scratch our head, because we only know the string path of the arc, not its runtime identifier.</li></ul><p>In other words, we need this:</p><ul><li>arcsToPatch =&gt; <!-- -->[arcA, arcD, ...]</li><li>arcA =&gt; <!-- -->[patch0, patch1, patch2, ...]</li></ul><p>but we have this:</p><ul><li>arcsToPatch =&gt; <!-- -->[&#x27;/res/Stage/D_MN10/R00_00.arc&#x27;, &#x27;/res/Stage/D_MN01/R03_00.arc&#x27;, ...]</li><li>&#x27;/res/Stage/D_MN10/R00_00.arc&#x27; =&gt; <!-- -->[patch0, patch1, patch2, ...]</li></ul><p>Fortunately, the game uses a function to convert between the filepath and its identifier, and we can use this as well.</p><p>So essentially, the complexity comes from the above conversion which must happen at runtime.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>We can document all of the path-to-identifier mappings so that we know them at compile time.
The problem is that if the user is playing on a modified ROM (such as tpgz), the identifiers for a given path may be different.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-structure">Current structure<a class="hash-link" href="#current-structure" title="Direct link to heading">â€‹</a></h2><p>The current approach is fairly straightforward.</p><p>We store an array which contains one entry for each patch.</p><p>Each entry specifies:</p><ul><li>the arc&#x27;s filepath</li><li>where to apply the patch</li><li>the patch data to apply</li></ul><p>Size is 0x20 bytes.</p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>0x00</td><td>u32</td><td>offset</td><td>The offset of the byte where the item is stored from the start of the file.</td></tr><tr><td>0x04</td><td>u32</td><td>arcFileIndex</td><td>The index of the file that contains the check.</td></tr><tr><td>0x08</td><td>u32</td><td>replacementValue</td><td>Used to be item (byte), but can be more now.</td></tr><tr><td>0xC</td><td>char<!-- -->[0x12]</td><td>fileName</td><td>The name of the file where the check is stored.</td></tr><tr><td>0x1E</td><td>u8 (enum)</td><td>fileDirectoryType</td><td>The type of directory where the check is stored.</td></tr><tr><td>0x1F</td><td>u8 (enum)</td><td>replacementType</td><td>The type of replacement that is taking place.</td></tr></tbody></table><p>Here is an example:</p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>0x00</td><td>u32</td><td>offset</td><td>0x8450C</td></tr><tr><td>0x04</td><td>u32</td><td>arcFileIndex</td><td>(Placeholder space which is filled at runtime by entryNum of arc file)</td></tr><tr><td>0x08</td><td>u32</td><td>replacementValue</td><td>0x42 (Ball and Chain itemId)</td></tr><tr><td>0xC</td><td>char<!-- -->[0x12]</td><td>fileName</td><td>&quot;D_MN11/R00_00.arc&quot;</td></tr><tr><td>0x1E</td><td>u8 (enum)</td><td>fileDirectoryType</td><td>0x0 (Stage)</td></tr><tr><td>0x1F</td><td>u8 (enum)</td><td>replacementType</td><td>0x0 (Item)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="problems-with-the-current-stucture">Problems with the current stucture<a class="hash-link" href="#problems-with-the-current-stucture" title="Direct link to heading">â€‹</a></h3><p>The main problem is the amount of space this takes up.</p><p>The expected patch count is currently 332.</p><blockquote><p>0x20 bytes per patch <!-- -->*<!-- --> 332 patches =&gt; 0x2980 bytes</p></blockquote><p>Yikes!
A block is only 0x2000 bytes, so we are using more than a block for this portion of the seed data alone.
Surely we can do better.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-improve">How to improve<a class="hash-link" href="#how-to-improve" title="Direct link to heading">â€‹</a></h3><p>The most obvious thing to look at is the <code>fileName</code>, which takes up 0x12 bytes per patch.
Remember, the patch is only 0x20 bytes long, so this means each seed would have 0x1758 bytes (1.5 blocks!) of the following:</p><p>&quot;D_MN11/R00_00.arc&quot;,&quot;D_MN11/R00_00.arc&quot;,&quot;D_MN11/R00_00.arc&quot;,&quot;D_MN11/R00_01.arc&quot;,&quot;D_MN11/R00_02.arc&quot;,...</p><p>And yes, you would have several copies of the same string if you needed to do multiple patches to the same arc.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a class="hash-link" href="#solution" title="Direct link to heading">â€‹</a></h4><p>Rather than looking at each patch and asking which ARC it affects, we can instead look at a given ARC and determine its patches.
So instead of having one string per patch, we could have many patches which are pointed to by one string (generally speaking).</p><p>Essentially, this means changing the structure to be more like a hierarchy/tree.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tree-structure">Tree Structure<a class="hash-link" href="#tree-structure" title="Direct link to heading">â€‹</a></h2><p>Example high-level representation:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  res: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Stage: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN01: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R00_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R01_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R03_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R05_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R06_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R07_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R08_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R09_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R10_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R11_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R12_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R13_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN01B: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R51_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN04: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R01_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R03_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R04_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R06_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R07_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R09_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R11_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R14_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R16_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R17_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN05: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R00_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R01_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R02_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R03_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R05_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R09_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R10_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R11_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R22_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>That looks an awful lot like the game&#x27;s directory structure.</p></div></div><p>Describing the tree will have some overhead, but we will be eliminating a ton of wasteful string data, so we will have plenty of space to work with.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="building-the-structure">Building the structure<a class="hash-link" href="#building-the-structure" title="Direct link to heading">â€‹</a></h3><ul><li>We can treat each directory and file as a node.<ul><li>The nodes themeselves can be stored in an array.</li></ul></li><li>We need to be able to look at a node and determine if it is a file or a directory.</li><li>If the node is a directory, we need to be able to find its children.</li><li>If the node is a file, we need to be able to find its patches.</li><li>We need to be able to determine the string name of each node.<ul><li>For example, &quot;res&quot; =&gt; &quot;Stage&quot; =&gt; &quot;D_MN01&quot;</li></ul></li></ul><p>Let us define a node structure at a high-level:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>Something like &quot;res&quot; or &quot;D_MN05&quot;.</td></tr><tr><td>isDir</td><td>Is this a directory or a file?</td></tr><tr><td>children</td><td>(directory only) Child nodes.</td></tr><tr><td>patches</td><td>(file only) Patches for this (arc) file.</td></tr></tbody></table><p>This is a little too abstract and needs to be broken down.</p><p>First, let&#x27;s learn from the <a href="https://wiki.cloudmodding.com/tww/ARC" target="_blank" rel="noopener noreferrer">RARC structure</a> and use a string table.</p><p>We will end up with something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">72 65 73 00 53 74 61 67 65 00 44 5F 4D 4E 30 35  res.Stage.D_MN05</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">00 44 5F 4D 4E 30 34 00 44 5F 4D 4E 30 31 00 44  .D_MN04.D_MN01.D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 4D 4E 30 31 42 00 44 5F 4D 4E 31 30 00 44 5F  _MN01B.D_MN10.D_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4D 4E 31 30 42 00 44 5F 4D 4E 31 31 00 44 5F 4D  MN10B.D_MN11.D_M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4E 31 31 42 00 44 5F 4D 4E 30 36 00 44 5F 4D 4E  N11B.D_MN06.D_MN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">30 36 42 00 44 5F 4D 4E 30 37 00 44 5F 4D 4E 30  06B.D_MN07.D_MN0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">37 42 00 44 5F 4D 4E 30 38 00 44 5F 4D 4E 30 39  7B.D_MN08.D_MN09</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">00 52 5F 53 50 30 31 00 44 5F 53 42 31 30 00 46  .R_SP01.D_SB10.F</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 53 50 31 30 38 00 52 5F 53 50 31 30 39 00 46  _SP108.R_SP109.F</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 53 50 31 32 31 00 46 5F 53 50 31 30 39 00 46  _SP121.F_SP109.F</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 53 50 31 31 31 00 46 5F 53 50 31 31 33 00 44  _SP111.F_SP113.D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 53 42 30 33 00 46 5F 53 50 31 31 35 00 46 5F  _SB03.F_SP115.F_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">53 50 31 31 30 00 44 5F 53 42 30 32 00 46 5F 53  SP110.D_SB02.F_S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">50 31 32 32 00 46 5F 53 50 31 32 34 00 44 5F 53  P122.F_SP124.D_S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">42 30 34 00 46 5F 53 50 31 31 38 00 46 5F 53 50  B04.F_SP118.F_SP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">31 31 34 00 44 5F 53 42 30 30 00 46 5F 53 50 31  114.D_SB00.F_SP1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">31 37 00 46 5F 53 50 31 31 36 00 62 6D 67 72 65  17.F_SP116.bmgre</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">73 35 00 62 6D 67 72 65 73 31 00 62 6D 67 72 65  s5.bmgres1.bmgre</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">73 36 00 62 6D 67 72 65 73 34 00 62 6D 67 72 65  s6.bmgres4.bmgre</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">73 32 00 62 6D 67 72 65 73 38 00 62 6D 67 72 65  s2.bmgres8.bmgre</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">73 37 00 52 32 32 5F 30 30 00 52 30 30 5F 30 30  s7.R22_00.R00_00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">00 52 30 39 5F 30 30 00 52 30 32 5F 30 30 00 52  .R09_00.R02_00.R</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">30 35 5F 30 30 00 52 30 33 5F 30 30 00 52 30 31  05_00.R03_00.R01</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5F 30 30 00 52 31 30 5F 30 30 00 52 31 31 5F 30  _00.R10_00.R11_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">30 00 52 31 34 5F 30 30 00 52 30 34 5F 30 30 00  0.R14_00.R04_00.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">52 30 36 5F 30 30 00 52 30 37 5F 30 30 00 52 31  R06_00.R07_00.R1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">37 5F 30 30 00 52 31 36 5F 30 30 00 52 30 38 5F  7_00.R16_00.R08_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">30 30 00 52 31 32 5F 30 30 00 52 31 33 5F 30 30  00.R12_00.R13_00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">00 52 35 31 5F 30 30 00 52 31 35 5F 30 30 00 00  .R51_00.R15_00..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Notice that we only need one copy of &quot;R01_00&quot; even though it is used in D_MN01, D_MN04, D_MN05, and I&#x27;m sure plenty of others.</p></div></div><p>Revisiting the structure</p><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><strong><em>strTableOffset</em></strong></td><td>u16?</td><td>Offset in string table</td></tr><tr><td>isDir</td><td>?</td><td>Is this a directory or a file?</td></tr><tr><td>children</td><td>?</td><td>(directory only) Child nodes.</td></tr><tr><td>patches</td><td>?</td><td>(file only) Patches for this (arc) file.</td></tr></tbody></table><p>Let&#x27;s look at &quot;patches&quot; now.</p><p>A node can have an arbitrary number of patches, so let&#x27;s go ahead and pull that out into its own table.</p><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>strTableOffset</td><td>u16?</td><td>Offset in string table</td></tr><tr><td>isDir</td><td>?</td><td>Is this a directory or a file?</td></tr><tr><td>children</td><td>?</td><td>(directory only) Child nodes.</td></tr><tr><td><strong><em>patchTableIndex</em></strong></td><td>u16?</td><td>(file only) Patches for this (arc) file.</td></tr><tr><td><strong><em>numPatches</em></strong></td><td>u8?</td><td>(file only) Number of patches for this (arc) file.</td></tr></tbody></table><p>Let&#x27;s look at &quot;children&quot; now.</p><p>A child is a Node, and we already have a table for this.
In fact, this structure we are describing is an entry in that table.</p><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>strTableOffset</td><td>u16?</td><td>Offset in string table</td></tr><tr><td>isDir</td><td>?</td><td>Is this a directory or a file?</td></tr><tr><td><strong><em>nodeTableIndex</em></strong></td><td>u16?</td><td>(directory only) Index of first child node.</td></tr><tr><td><strong><em>numChildren</em></strong></td><td>u8?</td><td>(directory only) Number of Child nodes.</td></tr><tr><td>patchTableIndex</td><td>u16?</td><td>(file only) Patches for this (arc) file.</td></tr><tr><td>numPatches</td><td>u8?</td><td>(file only) Number of patches for this (arc) file.</td></tr></tbody></table><p>Let&#x27;s see how much room this takes up:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>isDir</td><td>1 bit</td></tr><tr><td>strTableOffset</td><td>15 bits (10 is actually plenty here)</td></tr><tr><td>nodeTableIndex or patchTableIndex</td><td>u16</td></tr><tr><td>numChildren or numPatches</td><td>u8</td></tr></tbody></table><p>This takes up 5 bytes, which we can round up to 8.
If we can get this down to 4 bytes, the space we need for the node table will be cut in half.</p><p>We&#x27;ll come back to this.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="patches">Patches<a class="hash-link" href="#patches" title="Direct link to heading">â€‹</a></h2><p>When the ARC file is loaded, its path such as <code>/res/Stage/D_MN01/R01_00.arc</code> is converted to a u32 id called <code>entryNum</code>.</p><p>Let&#x27;s imagine we have a table which we will refer to as the RuntimeTable containing entries like the following:<br>
<em>(A better table name will be at end of this article once I come up with one.)</em></p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>entryNum</td><td>u32</td></tr><tr><td>patchTableIndex</td><td>u16</td></tr><tr><td>numPatches</td><td>u16</td></tr></tbody></table><p>Whenever an ARC is loaded, we can look at its <code>entryNum</code> then scan the above table.
If we find a match, we can use <code>patchTableIndex</code> and <code>numPatches</code> alongside the patch table itself to handle applying the appropriate patches.</p><p>Ideally, the only data we would have in the seed GCI&#x27;s ARC patch section are the above RuntimeTable and the patch table.
Unfortunately, we must wait until runtime to accurately convert filepaths to entryNums.</p><p>Let&#x27;s look at the chunks we have mentioned so far:</p><table><thead><tr><th>Name</th><th>Needed when?</th></tr></thead><tbody><tr><td>nodeTable</td><td>Not needed after creating runtimeTable</td></tr><tr><td>stringTable</td><td>Not needed after creating runtimeTable</td></tr><tr><td>patchTable</td><td>Needed</td></tr><tr><td>runtimeTable</td><td>Generated at runtime</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-runtimetable">Generating the RuntimeTable<a class="hash-link" href="#generating-the-runtimetable" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  res: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Stage: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN01: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R11_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R12_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R13_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN01B: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R51_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      D_MN04: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R01_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R03_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        R04_00: { patches: [] },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">},</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s pretend the above represents the ARCs which we want to patch.</p><p>To generate the runtimeTable, we need to navigate through the tree and convert each File node into the following:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>entryNum</td><td>u32</td></tr><tr><td>patchTableIndex</td><td>u16</td></tr><tr><td>numPatches</td><td>u16</td></tr></tbody></table><p>I&#x27;m going to keep track of a variable called <code>currentPatchIndex</code> to make a point later.</p><p>Here is how that (depth-first) traversal would look:</p><ul><li><code>currentPatchIndex</code> is 0.</li><li>At root. Not a file. numChildren is 1.</li><li>At <code>res</code>. Not a file. numChildren is 1.</li><li>At <code>Stage</code>. Not a file. numChildren is 3.</li><li>At <code>D_MN01</code>. Not a file. numChildren is 3.</li><li>At <code>R11_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 0. Copy into RuntimeTableEntry0.</li><li>the node&#x27;s <code>numPatches</code> property is 1. Copy into RuntimeTableEntry0.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (1).<ul><li><code>currentPatchIndex</code> becomes 1.</li></ul></li></ul></li><li>At <code>R12_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 1. Copy into RuntimeTableEntry1.</li><li>the node&#x27;s <code>numPatches</code> property is 3. Copy into RuntimeTableEntry1.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (3).<ul><li><code>currentPatchIndex</code> becomes 4.</li></ul></li></ul></li><li>At <code>R13_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 4. Copy into RuntimeTableEntry2.</li><li>the node&#x27;s <code>numPatches</code> property is 1. Copy into RuntimeTableEntry2.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (1).<ul><li><code>currentPatchIndex</code> becomes 5.</li></ul></li></ul></li><li>(That was the last entry in <code>D_MN01</code>, so will go to next child of <code>Stage</code>)</li><li>At <code>D_MN01B</code>. Not a file. numChildren is 1.</li><li>At <code>R51_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 5. Copy into RuntimeTableEntry3.</li><li>the node&#x27;s <code>numPatches</code> property is 2. Copy into RuntimeTableEntry3.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (2).<ul><li><code>currentPatchIndex</code> becomes 7.</li></ul></li></ul></li><li>(That was the last entry in <code>D_MN01B</code>, so will go to next child of <code>Stage</code>)</li><li>At <code>D_MN04</code>. Not a file. numChildren is 3.</li><li>At <code>R01_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 7. Copy into RuntimeTableEntry4.</li><li>the node&#x27;s <code>numPatches</code> property is 4. Copy into RuntimeTableEntry4.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (4).<ul><li><code>currentPatchIndex</code> becomes 11.</li></ul></li></ul></li><li>At <code>R03_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 11. Copy into RuntimeTableEntry5.</li><li>the node&#x27;s <code>numPatches</code> property is 1. Copy into RuntimeTableEntry5.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (1).<ul><li><code>currentPatchIndex</code> becomes 12.</li></ul></li></ul></li><li>At <code>R04_00</code>. Is a file.<ul><li><code>currentPatchIndex</code> and the node&#x27;s <code>patchTableOffset</code> property are both 12. Copy into RuntimeTableEntry6.</li><li>the node&#x27;s <code>numPatches</code> property is 1. Copy into RuntimeTableEntry6.</li><li>Increase <code>currentPatchIndex</code> by the number of patches (1).<ul><li><code>currentPatchIndex</code> becomes 13.</li></ul></li></ul></li><li>(That was the last entry in <code>D_MN04</code>)</li><li>(That was the last entry in <code>Stage</code>)</li><li>(That was the last entry in <code>res</code>)</li><li>(That was the last entry of the root)</li><li>We are done.</li></ul><p>The key takeaways are the following:</p><ol><li>The traversal is deterministic (will always be done in the same order).</li><li><code>currentPatchIndex</code> and <code>patchTableOffset</code> are equal every step of the way.</li></ol><p>Thus we can conclude:</p><ul><li>We do not need to store the patchTableOffset in the node data.</li></ul><p>Let&#x27;s look at what a Node might look like now:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>isDir</td><td>1 bit</td></tr><tr><td>strTableOffset</td><td>15 bits (10 is actually plenty here)</td></tr><tr><td>firstChildNodeIndex</td><td>(directory only) u16</td></tr><tr><td>numChildren or numPatches</td><td>u8</td></tr></tbody></table><ul><li>In the case of a File, we only need 24 bits.</li><li>In the case of a Directory, we need 40 bits.</li></ul><p>If we can get it down to &lt;= 32 bits in the case of a Directory, then we can cut the nodeTable size in half.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dirinfotable">DirInfoTable<a class="hash-link" href="#dirinfotable" title="Direct link to heading">â€‹</a></h2><p>Here is something we can do:</p><ul><li>Create another table called <code>dirInfoTable</code> which has entries like the following:</li></ul><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>firstChildNodeIndex</td><td>u16</td></tr><tr><td>numChildren</td><td>u16</td></tr></tbody></table><ul><li>Then change Node to look like this:</li></ul><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>isDir</td><td>1 bit</td></tr><tr><td>strTableOffset</td><td>15 bits (10 is actually plenty here)</td></tr><tr><td>dirInfoIndex (dir) or numPatches (file)</td><td>u8</td></tr></tbody></table><p>We have pulled out the data which is only needed for the Directory nodes into their own table.
There is only one entry for a directory node, and 0 for a file node.
Since the majority of our nodes are files, this saves quite a bit of space.</p><p>So now both the File node and Directory node only need 24 bytes.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>We can store <code>dirInfoIndex</code> as a u8 because there is a maximum of 90 directory nodes in the game based on the exhaustive list of arc files which is well under the 255 max for a u8.</p><p>Probably won&#x27;t be doing anywhere close to 255 patches on an individual arc, so u8 for <code>numPatches</code> should be fine as well.</p></div></div><p>But we can do even better.</p><p>Storing this as 3 bytes would force us to round up to 4, but we can store it in 2 arrays so that we only use 3 bytes while still having the data nicely aligned.</p><p>First array will contain NodeInfoA (size: 2 bytes):</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>isDir</td><td>1 bit</td></tr><tr><td>Reserved bits (more on this later)</td><td>3 bits</td></tr><tr><td>strTableOffset</td><td>12 bits</td></tr></tbody></table><p>Second array will contain NodeInfoB (size: 1 byte):</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>dirInfoIndex (dir) or numPatches (file)</td><td>u8</td></tr></tbody></table><p>At this point, we have all of the pieces we need to describe the following:</p><ul><li>arcsToPatch =&gt; <!-- -->[arcA, arcD, arcQ, arc7, arcC, arc2, ...]</li></ul><p>Now we just need to go discuss this part:</p><ul><li>arcA =&gt; <!-- -->[patch0, patch1, patch2, ...]</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="patches-part-2">Patches Part 2<a class="hash-link" href="#patches-part-2" title="Direct link to heading">â€‹</a></h2><p>A patch is made up of the following information:</p><ul><li>Where should we overwrite bytes</li><li>What value should we write there</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-offset">Patch offset<a class="hash-link" href="#patch-offset" title="Direct link to heading">â€‹</a></h3><p>The largest arc file is <code>/res/Object/Demo28_01.arc</code> which is 3603200 bytes when uncompressed, or 0x0036FB00.</p><p>This means 3 bytes will always be enough to specify the offset at which we will write the patch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-contents">Patch contents<a class="hash-link" href="#patch-contents" title="Direct link to heading">â€‹</a></h3><p>The first thing to note is that the patch we want to write could be 1, 2, or 4 bytes, so we will need a way to specify how many bytes we should write.</p><p>Let&#x27;s use a u8 enum for this.</p><p>Here is what we have so far:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>patchType</td><td>u8</td></tr><tr><td>offset</td><td>3 bytes</td></tr><tr><td>Remaining space</td><td>4 bytes</td></tr></tbody></table><p>We can use the patchType enum to specify what is in the remaining space.</p><p>For example, if we needed to patch an itemId which is 1 byte, we could have something like the following:</p><p><code>[00 05 E6 EC 00 00 00 45]</code></p><p>meaning:</p><ul><li>patchType: 0 (ItemId)</li><li>offset: 0x05E6EC</li><li>value: 0x45 (<code>patchType</code> indicates that the value is 1 byte)</li></ul><p>Example 2:</p><p><code>[01 02 FB 6C 00 00 AB CD]</code></p><p>meaning:</p><ul><li>patchType: 1 (ItemMessage)</li><li>offset: 0x02FB6C</li><li>value: 0xABCD (<code>patchType</code> indicates that the value is 2 bytes)</li></ul><p>If we have a type of patch that only needs to write 1, 2, 3, or 4 bytes, we can fit that into the remaining space.</p><p>But what if we want to write more than 4 bytes?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-contents-extended">Patch contents extended<a class="hash-link" href="#patch-contents-extended" title="Direct link to heading">â€‹</a></h3><p>Let&#x27;s create another chunk and call it patchExtensions.
It is a stream of bytes which contains data for patches that are too big to fit into the 2nd half of the patch.</p><p>A patch&#x27;s <code>patchType</code> will indicate if a patch uses the patchExtensions chunk.</p><p>For example:</p><p><code>[AB 01 A6 6F 01 23 00 0C]</code></p><p>meaning:</p><ul><li>patchType: 0xAB (LongPatch) (enum value was chosen arbitrarily)</li><li>offset: 0x01A66F</li><li>patchExtensionsOffset: 0x0123</li><li>patchBytelength: 0x000C</li></ul><p>Notice that the 2nd group of 4 bytes has a completely different meaning than before.
That is the power of using the <code>patchType</code> enum -- the remaining 4 bytes can be interpreted according to the value of the enum.</p><p>The patchExtensions chunk is a stream of bytes, so according to the above Patch, we should start at byte 0x123 in the extensions chunk and copy 0xC bytes into the arc data starting at offset 0x01A66F.</p><p>Here is an example of another kind of patch you might use:</p><p><code>[CD 0B FA E0 00 F3 00 FF]</code></p><p>meaning:</p><ul><li>patchType: 0xCD (LongPatchSkipBytes)</li><li>offset: 0x0BFAE0</li><li>patchExtensionsOffset: 0x00F3</li><li>skipIfByteIs: 0xFF</li></ul><p>We didn&#x27;t specify the byteLength, but let&#x27;s check what the data looks like in the extensions section:</p><p><code>[00 08 67 FF FF 63 FF FF 12 34]</code></p><p>Let&#x27;s assume that <code>LongPatchSkipBytes</code> means that the first 2 bytes in the extensions section will indicate the length.</p><p>In this case, the byte length is 8.</p><p>The <code>skipIfByteIs</code> is 0xFF, so we will copy the next 8 bytes, but we will skip over any bytes which have a value of 0xFF.</p><p>Those were just some examples.
You can really do whatever you want with the enum, and the good news is that you can easily add new enum types without breaking backwards compatibility.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This extension section is just an idea.
It wouldn&#x27;t be included until/unless we actually need it.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-content-optimization">Patch Content Optimization<a class="hash-link" href="#patch-content-optimization" title="Direct link to heading">â€‹</a></h3><p>Our patches currently look like the following:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>patchType</td><td>u8</td></tr><tr><td>offset</td><td>3 bytes</td></tr><tr><td>Remaining space</td><td>4 bytes</td></tr></tbody></table><p>In terms of our current seed&#x27;s <code>ARCP</code> section size, these actually take up the majority of the space, so if we can improve this we will get some pretty significant gains.</p><p>Of our 332 patches currently, 288 only need one byte of the &quot;Remaining space&quot; bytes (meaning they waste 3 bytes), and the other 44 are message indexes (meaning they waste 2 bytes).</p><p>Let&#x27;s create another chunk called patchContent and write the values that we would have put in the &quot;Remaining space&quot; in the above table there in a back-to-back fashion.</p><p>As we iterate through the patches (which are now 4 bytes long), we can use <code>patchType</code> to determine how many bytes to read from the patchContent.
We will keep track of our current position in patchContent (which is essentially a data stream) as we do this.</p><p>So patches look like this now:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>patchType</td><td>u8</td></tr><tr><td>offset (to apply patch in arc)</td><td>3 bytes</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="special-string-values">Special String Values<a class="hash-link" href="#special-string-values" title="Direct link to heading">â€‹</a></h2><p>Earlier we described the string table.
The keen eye may have noticed that it had <code>bmgres4</code> in it, but nothing like <code>Msgus</code>.</p><p>This is because the exact name that should be used in place of <code>Msgus</code> depends on the TP region you are playing (US, PAL, JP) and will be filled in at runtime by the Randomizer.</p><p>We can use a bit in the NodeA entry to indicate that it is a string enum and not a value in the string table as follows:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>isDir</td><td>1 bit</td></tr><tr><td>isStringEnum</td><td>1 bit</td></tr><tr><td>Reserved bits (more on this later)</td><td>2 bits</td></tr><tr><td>strTableOffset or stringEnum</td><td>12 bits</td></tr></tbody></table><p>So for example:</p><p><code>[80 05]</code> is a directory node, and its name is stored at offset 0x5 in the string table.</p><p><code>[C0 AA]</code> is a directory node.
It uses a string enum rather than the string table, and its enum is 0xAA.
The Randomizer was compiled for the US version, so it knows that the value of enum 0xAA is <code>Msgus</code>.</p><p>That should be all of the areas we need to discuss regarding the inner structure.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="header">Header<a class="hash-link" href="#header" title="Direct link to heading">â€‹</a></h2><p>The entire structure is split up into the chunks we discussed above, so we will use a header to indicate things like the offset to a chunk and how many entries are in it.</p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>0x00</td><td>char<!-- -->[4]</td><td>offset</td><td>Always &quot;ARCP&quot;</td></tr><tr><td>0x04</td><td>u8</td><td>majorVersion</td><td>This is independent of the randomizer version</td></tr><tr><td>0x05</td><td>u8</td><td>minorVersion</td><td>This is independent of the randomizer version</td></tr><tr><td>0x06</td><td>u16</td><td>totalSize</td><td>Total byte size of ARCP section</td></tr><tr><td>0x08</td><td>u16</td><td>nodeInfoAOffset</td><td>Offset to NodeInfoA table</td></tr><tr><td>0x0A</td><td>u16</td><td>nodeInfoBOffset</td><td>Offset to NodeInfoB table</td></tr><tr><td>0x0C</td><td>u16</td><td>numNodes</td><td>Number of entries in NodeInfoA and NodeInfoB tables</td></tr><tr><td>0x0E</td><td>u16</td><td>dirInfoOffset</td><td>Offset to DirInfo table</td></tr><tr><td>0x10</td><td>u16</td><td>numDirInfos</td><td>Number of entries in DirInfo table</td></tr><tr><td>0x12</td><td>u16</td><td>strTableOffset</td><td>Offset to string table</td></tr><tr><td>0x14</td><td>u16</td><td>patchTableOffset</td><td>Offset to Patch table</td></tr><tr><td>0x16</td><td>u16</td><td>numPatches</td><td>Number of entries in Patch table</td></tr><tr><td>0x18</td><td>u16</td><td>patchExtOffset</td><td>Offset to PatchExtensions chunk</td></tr><tr><td>0x8</td><td>u8<!-- -->[8]</td><td>padding/reserved</td><td>Currently unused, rounds header to 0x20 bytes</td></tr></tbody></table><ul><li>The section title of &quot;ARCP&quot; (short for Arc Patch) is to make it easier to visually understand what you are looking at when inspecting in a hex editor.
This is inspired by how many of the files are already handled in TP.
Might be useful some other way at some point as well.
We also have room for it.</li></ul><p>Major version is a u8 which gets incremented every time there is a change which breaks backwards compatibility.</p><ul><li>The benefit of storing a version number at this level rather than just at the top SeedInfo level is that the Randomizer can check the ArcPatch section&#x27;s version and run the appropriate routines based off of that (if that version of the Randomizer was supporting multiple ARCP major versions at the same time, for example).</li></ul><p>Minor version number is more for debugging purposes.
This would be incremented whenever a non-breaking change is made, such as adding a <code>patchType</code> enum or a string enum such as the one which is used for <code>Msgus</code>.
Non-breaking in the sense that version 42.4 is essentially a superset of 42.3.</p><ul><li><p>Incrementing the major or minor version of the ARCP section would also increment the version number of SeedInfo as appropriate.</p></li><li><p>totalSize is the total number of bytes of the ARCP section.
Each chunk will be rounded to a multiple of 0x10, so this value will also always be rounded to 0x10.</p></li><li><p>patchExtOffset will be 0x0000 if there is no patchExtensions chunk (because it is not needed).
Or realistically it will always be 0x0000 until we actually have something that needs the extensions chunk.</p></li></ul><p>Now we are ready to put everything together.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="structure-definition">Structure Definition<a class="hash-link" href="#structure-definition" title="Direct link to heading">â€‹</a></h2><p>The ARCP section will be broken into the following chunks:</p><table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody><tr><td>Header</td><td>object</td></tr><tr><td>NodeInfoA</td><td>array</td></tr><tr><td>NodeInfoB</td><td>array</td></tr><tr><td>DirInfo</td><td>array</td></tr><tr><td>StrTable</td><td>chunk</td></tr><tr><td>PatchTable</td><td>array</td></tr><tr><td>PatchContent</td><td>chunk</td></tr><tr><td>PatchExtensions</td><td>chunk</td></tr></tbody></table><p>At runtime, this will transform into another block of data:</p><table><thead><tr><th>Name</th><th>Type</th><th>source</th></tr></thead><tbody><tr><td>RuntimeHeader</td><td>object</td><td>generated</td></tr><tr><td>ArcList</td><td>array</td><td>generated</td></tr><tr><td>PatchTable</td><td>array</td><td>generated</td></tr><tr><td>PatchExtensions</td><td>chunk</td><td>copied</td></tr></tbody></table><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>We may not actually want to add the PatchExtensions part until/unless it becomes necessary, but we can leave space for it in the header to make it easily backwards compatible.</p></div></div><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="structures-in-gci">Structures in GCI<a class="hash-link" href="#structures-in-gci" title="Direct link to heading">â€‹</a></h3><p><strong>Header (size: 0x20):</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>0x00</td><td>char<!-- -->[4]</td><td>offset</td><td>Always &quot;ARCP&quot;</td></tr><tr><td>0x04</td><td>u8</td><td>majorVersion</td><td>This is independent of the randomizer version</td></tr><tr><td>0x05</td><td>u8</td><td>minorVersion</td><td>This is independent of the randomizer version</td></tr><tr><td>0x06</td><td>u16</td><td>totalSize</td><td>Total byte size of ARCP section</td></tr><tr><td>0x08</td><td>u16</td><td>numNodes</td><td>Number of entries in NodeInfoA and NodeInfoB tables</td></tr><tr><td>0x0A</td><td>u16</td><td>nodeInfoAOffset</td><td>Offset to NodeInfoA table</td></tr><tr><td>0x0C</td><td>u16</td><td>nodeInfoBOffset</td><td>Offset to NodeInfoB table</td></tr><tr><td>0x0E</td><td>u16</td><td>numDirInfos</td><td>Number of entries in DirInfo table</td></tr><tr><td>0x10</td><td>u16</td><td>dirInfoOffset</td><td>Offset to DirInfo table</td></tr><tr><td>0x12</td><td>u16</td><td>strTableOffset</td><td>Offset to string table</td></tr><tr><td>0x14</td><td>u16</td><td>numPatches</td><td>Number of entries in Patch table</td></tr><tr><td>0x16</td><td>u16</td><td>patchTableOffset</td><td>Offset to Patch table</td></tr><tr><td>0x18</td><td>u16</td><td>patchContentOffset</td><td>Offset to Patch content stream</td></tr><tr><td>0x1A</td><td>u16</td><td>numArcs</td><td>Number of nodes of type &quot;File&quot;</td></tr><tr><td>0x1C</td><td>u16</td><td>patchExtOffset</td><td>Offset to PatchExtensions chunk (0 if unused)</td></tr><tr><td>0x1E</td><td>u8<!-- -->[2]</td><td>padding/reserved</td><td>Currently unused, rounds header to 0x20 bytes</td></tr></tbody></table><p><strong>NodeInfoA (size: 0x2):</strong></p><table><thead><tr><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>1 bit</td><td>isDir</td></tr><tr><td>1 bit</td><td>isStringEnum</td></tr><tr><td>2 bits</td><td>Reserved/unused bits</td></tr><tr><td>12 bits</td><td>strTableOffset (u16 &amp; 0xFFF) or stringEnum (u16 &amp; 0xFF)</td></tr></tbody></table><p><strong>NodeInfoB (size: 0x1):</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>0x0</td><td>u8</td><td>dirInfoIndex (dir) or numPatches (file)</td></tr></tbody></table><p><strong>DirInfo (size: 0x4):</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>0x0</td><td>u16</td><td>firstChildIndex</td></tr><tr><td>0x2</td><td>u16</td><td>numChildren</td></tr></tbody></table><p><strong>StrTable:</strong></p><p>Back-to-back null-terminated strings.</p><p><strong>PatchTable (size: 0x4):</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>0x0</td><td>u8</td><td>patchType</td></tr><tr><td>0x0 &amp; 0x00FFFFFF</td><td>u32 (3 bytes)</td><td>offset</td></tr></tbody></table><p><strong>PatchContent:</strong></p><p>Stream of bytes.</p><p><strong>PatchExtensions:</strong></p><p>Optional chunk of bytes.
Patches can point to data in here.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generated-structures">Generated Structures<a class="hash-link" href="#generated-structures" title="Direct link to heading">â€‹</a></h3><p><strong>RuntimeHeader:</strong></p><p>Not really in the scope of this article to define an exact structure for this, but it will need something to do the following:</p><ul><li>pointer/offset to ArcList</li><li>pointer/offset to PatchTable</li><li>pointer/offset to PatchExtensions</li><li>way to free data</li></ul><p><strong>ArcList:</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>0x0</td><td>u32</td><td>entryNum (returned from <code>my_DVDConvertPathToEntrynum</code>)</td></tr><tr><td>0x4</td><td>u16</td><td>patchTableIndex</td></tr><tr><td>0x6</td><td>u16</td><td>numPatches</td></tr></tbody></table><p><strong>PatchTable (size: 0x8):</strong></p><table><thead><tr><th>Offset</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>0x0</td><td>u8 (enum)</td><td>patchType</td></tr><tr><td>0x0 &amp; 0x00FFFFFF</td><td>u32 (3 bytes)</td><td>offset</td></tr><tr><td>0x4</td><td>4 bytes</td><td>remainingSpace</td></tr></tbody></table><p><strong>PatchExtensions:</strong></p><p>Copied directly from ARCP section.
Optional chunk of bytes.
Patches can point to data in here.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-thoughts">Other thoughts<a class="hash-link" href="#other-thoughts" title="Direct link to heading">â€‹</a></h2><p>There is another optimization which can be done.
You can make a change such that:</p><ul><li><code>[bmgres1,bmgres4,bmgres5,bmgres6,bmgres7,bmgres8]</code></li></ul><p>changes to something more like:</p><ul><li><code>[bmgres] =&gt; [1,4,5,6,7,8]</code></li></ul><p>for this and similar strings, but this adds a lot of complexity (to generating the GCI) and saves very little space, so it is not really worth it.</p><p>Here is validated example data which has you can view in a hex editor:</p><p><a target="_blank" href="/tp-docs/binData/arcpExampleData.bin">Download arcpExampleData.bin</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/icogn/tp-docs/edit/main/website/docs/technical-explanations/rando-seedInfo-arcp-proposal.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tp-docs/docs/technical-explanations/rando-seed-versioning"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Rando Seed Versioning</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tp-docs/docs/technical-explanations/rando-seedInfo-clr0"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Rando SeedInfo CLR0 Structure</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#benefits" class="table-of-contents__link toc-highlight">Benefits</a><ul><li><a href="#trade-offs" class="table-of-contents__link toc-highlight">Trade-offs</a></li></ul></li><li><a href="#at-a-high-level" class="table-of-contents__link toc-highlight">At a high level</a><ul><li><a href="#the-problem" class="table-of-contents__link toc-highlight">The problem</a></li></ul></li><li><a href="#current-structure" class="table-of-contents__link toc-highlight">Current structure</a><ul><li><a href="#problems-with-the-current-stucture" class="table-of-contents__link toc-highlight">Problems with the current stucture</a></li><li><a href="#how-to-improve" class="table-of-contents__link toc-highlight">How to improve</a></li></ul></li><li><a href="#tree-structure" class="table-of-contents__link toc-highlight">Tree Structure</a><ul><li><a href="#building-the-structure" class="table-of-contents__link toc-highlight">Building the structure</a></li></ul></li><li><a href="#patches" class="table-of-contents__link toc-highlight">Patches</a></li><li><a href="#generating-the-runtimetable" class="table-of-contents__link toc-highlight">Generating the RuntimeTable</a></li><li><a href="#dirinfotable" class="table-of-contents__link toc-highlight">DirInfoTable</a></li><li><a href="#patches-part-2" class="table-of-contents__link toc-highlight">Patches Part 2</a><ul><li><a href="#patch-offset" class="table-of-contents__link toc-highlight">Patch offset</a></li><li><a href="#patch-contents" class="table-of-contents__link toc-highlight">Patch contents</a></li><li><a href="#patch-contents-extended" class="table-of-contents__link toc-highlight">Patch contents extended</a></li><li><a href="#patch-content-optimization" class="table-of-contents__link toc-highlight">Patch Content Optimization</a></li></ul></li><li><a href="#special-string-values" class="table-of-contents__link toc-highlight">Special String Values</a></li><li><a href="#header" class="table-of-contents__link toc-highlight">Header</a></li><li><a href="#structure-definition" class="table-of-contents__link toc-highlight">Structure Definition</a><ul><li><a href="#structures-in-gci" class="table-of-contents__link toc-highlight">Structures in GCI</a></li><li><a href="#generated-structures" class="table-of-contents__link toc-highlight">Generated Structures</a></li></ul></li><li><a href="#other-thoughts" class="table-of-contents__link toc-highlight">Other thoughts</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 icogn</div></div></div></footer></div>
<script src="/tp-docs/assets/js/runtime~main.adbb371e.js"></script>
<script src="/tp-docs/assets/js/main.789a4f82.js"></script>
</body>
</html>