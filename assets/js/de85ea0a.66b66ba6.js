"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9342],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>p});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),h=d(n),c=r,p=h["".concat(s,".").concat(c)]||h[c]||m[c]||i;return n?a.createElement(p,l(l({ref:t},u),{},{components:n})):a.createElement(p,l({ref:t},u))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[h]="string"==typeof e?e:r,l[1]=o;for(var d=2;d<i;d++)l[d]=n[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6221:(e,t,n)=>{n.d(t,{Z:()=>R});var a=n(7294),r=n(6010);const i=40500000n,l=40500n,o=86400n,s=730485n,d=-1840700269n,u=-2004318071n,h=-1282606671n,m=1374389535n,c=[0,31,59,90,120,151,181,212,243,273,304,334],p=[0,31,60,91,121,152,182,213,244,274,305,335];function f(e){const t=BigInt("0x"+e),n={},a=t%i;let r=8n*a/324n;r%=1000n,n.microseconds=Number(r);let f=a/l;f%=1000n,n.milliseconds=Number(f);const y=(t-a)/i;!function(e,t){const n=e+6n,a=n-7n*(n+(d*n>>0x20n)>>2n);t.dayOfWeek=Number(a);const r=e*h>>0x20n,i=e+r;let l,o=i>>8n,s=365n*o;for(;;){let t;if(o>=1n){const e=(o-1n)*m>>0x20n;t=(o+3n>>2n)-(e>>5n)+(e>>7n)}else t=0n;if(l=s+t,l<=e)break;o-=1n,s-=365n}const u=Number(e-l);t.year=Number(o),t.dayOfYear=u;let f=!0,y=!1;if(4n*(o>>2n)===o){100n*(o*m>>0x20n>>5n)!==o&&(y=!0)}if(!y){400n*(o*m>>0x20n>>7n)!==o&&(f=!1)}let k;k=f?p:c;let g=12;for(;;){g-=1;if(u>=k[g])break}t.month=g;const N=k[g],w=u-N+1;t.day=w}(y/o+s,n);const k=y%o,g=k+(u*k>>0x20n)>>5n,N=g+(u*g>>0x20n)>>5n,w=60n*N;n.hours=Number(N);const b=60n*g,O=g-w;n.minutes=Number(O);const v=k-b;return n.seconds=Number(v),n}const y="outputText_F4so",k="error_nwlf",g="dateFormat_HHIs",N="swapButton_KciG",w=40500000n,b=86400n,O=3600n,v=60n,T=0x7fffffffffffffffn,C=1374389535n,x=/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})$/,S=/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.?)(\d{0,6})$/,D=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],_={1:"st",2:"nd",3:"rd"};function P(e,t){for(e=String(e);e.length<t;)e="0"+e;return e}function E(e){return P(e,2)}function Y(e,t){if(t){e=(BigInt("0x"+e)*w).toString(16)}const{year:n,month:a,day:r,hours:i,minutes:l,seconds:o,milliseconds:s,microseconds:d,dayOfWeek:u,dayOfYear:h}=f(e),m=t?"":`.${P(s,3)}${P(d,3)}`;return`${n}/${E(a+1)}/${E(r)} ${E(i)}:${E(l)}:${E(o)}${m} (${D[u]})\nThis is the ${function(e){const t=String(e+1),n=t.charAt(t.length-1);return t+(_[n]||"th")}(h)} day of the year.`}const M=[0,31,59,90,120,151,181,212,243,273,304,334],I=[0,31,60,91,121,152,182,213,244,274,305,335];function W(e){let{year:t,month:n,day:a,hours:r,minutes:i,seconds:l,fractionalSeconds:o}=e,s=0n;return s+=function(e){let t;if((e-=2000n)>=1n){const n=(e-1n)*C>>0x20n;t=(e+3n>>2n)-(n>>5n)+(n>>7n)}else t=0n;return(365n*e+t)*b*w}(t),s+=function(e,t,n){let a,r=!0,i=!1;4n*(e>>2n)===e&&100n*(e*C>>0x20n>>5n)!==e&&(i=!0);i||400n*(e*C>>0x20n>>7n)!==e&&(r=!1);return a=r?I:M,(BigInt(a[t])+n-1n)*b*w}(t,n,a),s+=r*O*w,s+=i*v*w,s+=l*w,s+=324n*o/8n,s>T?-1n:s}function H(e,t){if("string"!=typeof e||e.length<1)return{ignore:!0};let n,a,r,i,l,o,s=0n;if(t){const t=e.match(x);if(!t)return{error:"Input does not match the format: YYYY/MM/DD hh:mm:ss"};n=BigInt(t[1]),a=BigInt(t[2])-1n,r=BigInt(t[3]),i=BigInt(t[4]),l=BigInt(t[5]),o=BigInt(t[6])}else{const t=e.match(S);if(!t||0===t[7].length&&t[8].length>0)return{error:"Input does not match the format: YYYY/MM/DD hh:mm:ss.ssssss"};n=BigInt(t[1]),a=BigInt(t[2])-1n,r=BigInt(t[3]),i=BigInt(t[4]),l=BigInt(t[5]),o=BigInt(t[6]),s=BigInt(function(e,t){for(e=String(e);e.length<t;)e+="0";return e}(t[8],6))}if(n<2000n)return{error:"Minimum year is 2000."};if(a<0||a>11)return{error:"Month must be between 01 and 12."};if(r<1)return{error:"Day must be at least 01."};if(i>=24)return{error:"Hours must be between 00 and 23"};if(l>=60)return{error:"Minutes must be between 00 and 59"};if(o>=60)return{error:"Minutes must be between 00 and 59"};let d=W({year:n,month:a,day:r,hours:i,minutes:l,seconds:o,fractionalSeconds:s});return d<0?{error:"Pick an earlier time."}:t&&(d/=w,d>0xffffffffn)?{error:"Max time is 2136/02/07 06:28:15"}:{val:P(d.toString(16),t?8:16),error:""}}function L(e,t){return e?t?20:40:t?19:26}const R=function(e){let{sourceName:t,useSeconds:n}=e;const i=(0,a.useRef)(null),[l,o]=(0,a.useState)(!0),[s,d]=(0,a.useState)(""),[u,h]=(0,a.useState)(!1);return a.createElement("div",null,a.createElement("div",null,t?function(e,t){return t?`${e} to Time Converter`:`Time to ${e} Converter`}(t,l):"TimestampConverter"),a.createElement("input",{maxLength:L(l,n),ref:i}),a.createElement("button",{onClick:function(){if(i.current)if(l){const{val:e,error:t,ignore:a}=function(e,t){let n=e.replaceAll(/\s/g,"");if(0===n.toLowerCase().indexOf("0x")&&(n=n.substring(2)),n.length<1)return{ignore:!0};if(t&&n.length>8)return{error:"Expected 8 hex digits."};if(!/^[0-9a-f]*$/gi.test(n))return{error:"Invalid characters."};if(!t){if(n.length>16)return{error:"Expected 16 hex digits."};if(16===n.length&&/^[89a-f]/i.test(n))return{error:"Input must be positive."}}return{val:n,error:""}}(i.current.value,n);h(Boolean(t)),a?d(""):t?d(t):e&&e.length>0?d(Y(e,n)):d("")}else{const{val:e,error:t,ignore:a}=H(i.current.value,n);h(Boolean(t)),a?d(""):t?d(t):e&&e.length>0?d(e):d("")}}},"Convert"),!l&&a.createElement("div",{className:g},"YYYY/MM/DD hh:mm:ss"+(n?"":"[.s] (Up to 6 digits after seconds)")),a.createElement("div",{className:(0,r.Z)({[y]:!0,[k]:u}),style:{display:s?void 0:"none"}},s),a.createElement("button",{className:N,onClick:()=>{i.current&&(i.current.value=""),d(""),o(!l)}},"Swap"))}},113:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>c,frontMatter:()=>o,metadata:()=>d,toc:()=>h});var a=n(7462),r=(n(7294),n(3905)),i=n(9960),l=n(6221);const o={},s="OSTicksToCalendarTime",d={unversionedId:"technical-explanations/ostickstocalendartime",id:"technical-explanations/ostickstocalendartime",title:"OSTicksToCalendarTime",description:"This page explains the calculations behind converting a timestamp such as 00615b390fb0dcef to something like 2021/06/10 07:48.",source:"@site/docs/technical-explanations/ostickstocalendartime.mdx",sourceDirName:"technical-explanations",slug:"/technical-explanations/ostickstocalendartime",permalink:"/tp-docs/docs/technical-explanations/ostickstocalendartime",draft:!1,editUrl:"https://github.com/icogn/tp-docs/edit/main/website/docs/technical-explanations/ostickstocalendartime.mdx",tags:[],version:"current",frontMatter:{},sidebar:"technicalExplanations",next:{title:"Rando Seed File Thoughts",permalink:"/tp-docs/docs/technical-explanations/rando-seed-file-thoughts"}},u={},h=[{value:"Introduction",id:"introduction",level:2},{value:"Sample Code and Organization",id:"sample-code-and-organization",level:3},{value:"Fractional Seconds",id:"fractional-seconds",level:2},{value:"Where does 730,485 come from?",id:"where-does-730485-come-from",level:3},{value:"GetDates",id:"getdates",level:2},{value:"Day of the Week",id:"day-of-the-week",level:2},{value:"Year and Day of the Year",id:"year-and-day-of-the-year",level:2},{value:"Month and Day of the Month",id:"month-and-day-of-the-month",level:2},{value:"Hours, Minutes, Seconds",id:"hours-minutes-seconds",level:2},{value:"Closing Thoughts",id:"closing-thoughts",level:2},{value:"Naming",id:"naming",level:2},{value:"References",id:"references",level:2}],m={toc:h};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"ostickstocalendartime"},"OSTicksToCalendarTime"),(0,r.kt)("p",null,"This page explains the calculations behind converting a timestamp such as ",(0,r.kt)("inlineCode",{parentName:"p"},"00615b390fb0dcef")," to something like ",(0,r.kt)("inlineCode",{parentName:"p"},"2021/06/10 07:48"),"."),(0,r.kt)(l.Z,{sourceName:"Timestamp",mdxType:"TimestampConverter"}),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"A timestamp is a 64 bit integer which counts the number of OSTicks since 2000/01/01 at 00:00."),(0,r.kt)("p",null,"OSTicks increase at a rate of exactly 40,500,000 per second. This is 1/12 of the 486 MHz clockrate of the Gekko CPU. It is also 1/4 of 162,000,000, which is an important value stored as a word at address 800000f8. The value at this address is frequently loaded and right-shifted by 2 during calculations involving the timestamp."),(0,r.kt)("p",null,"The function ",(0,r.kt)("inlineCode",{parentName:"p"},"OSTicksToCalendarTime")," takes 2 parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The timestamp (something like ",(0,r.kt)("inlineCode",{parentName:"li"},"00615b390fb0dcef"),")"),(0,r.kt)("li",{parentName:"ul"},"An ",(0,r.kt)("inlineCode",{parentName:"li"},"OSCalendarTime")," object to write results to.")),(0,r.kt)("p",null,"Time information is generated from the timestamp and written to the ",(0,r.kt)("inlineCode",{parentName:"p"},"OSCalendarTime")," object which has the following structure:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Offset"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x00"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"seconds")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x04"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"minutes")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x08"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"hours")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x0c"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"day of the month (1-31)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x10"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"month (0-11)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x14"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"year (2000+)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x18"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"day of the week (0-6)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x1c"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"day of the year (0-365)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x20"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"milliseconds (0-999)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0x24"),(0,r.kt)("td",{parentName:"tr",align:null},"s32"),(0,r.kt)("td",{parentName:"tr",align:null},"microseconds (0-999)")))),(0,r.kt)("h3",{id:"sample-code-and-organization"},"Sample Code and Organization"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"All of the sample code on this page is written in JavaScript. The logic behind the conversion component at the top of this page was essentially copy-pasted from here."),(0,r.kt)("li",{parentName:"ul"},"The 'n' characters at the end of the numbers make them BigInts. This is necessary to handle the large numbers we are working with in these calculations. You can ignore them as you read the code.")),(0,r.kt)("p",null,"The following sections will roughly follow the order the calculations actually run in the code.",(0,r.kt)("br",null),"\nSome parts will be simplified or skipped, such as calculations which lead to the same constant every time."),(0,r.kt)("h2",{id:"fractional-seconds"},"Fractional Seconds"),(0,r.kt)("p",null,"The first things we determine are the microseconds and milliseconds."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const TICKS_PER_SECOND = 40500000n;\nconst TICKS_PER_MS = 40500n;\n\nconst fractionalSecondTicks = timestamp % TICKS_PER_SECOND;\n\nlet microseconds = (fractionalSecondTicks * 8n) / 324n; // divide by 40.5 for microseconds\nmicroseconds = microseconds % 1000n;\n// Store microseconds at offset 0x24.\n\nlet milliseconds = fractionalSecondTicks / TICKS_PER_MS;\nmilliseconds = milliseconds % 1000n; // Not strictly necessary, but done nonetheless\n// Store milliseconds at offset 0x20.\n")),(0,r.kt)("p",null,"Next, we determine the ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," which we will pass to ",(0,r.kt)("inlineCode",{parentName:"p"},"GetDates"),".",(0,r.kt)("br",null),"\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," is how many days after Jan 1, 0000 the day the timestamp refers to is."),(0,r.kt)("p",null,"Day offset examples:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Jan 1, 0000 has a day offset of 0."),(0,r.kt)("li",{parentName:"ul"},"Jan 2, 0000 has a day offset of 1."),(0,r.kt)("li",{parentName:"ul"},"Jan 8, 0000 has a day offset of 7.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// ...\nconst SECONDS_PER_DAY = 86400n; // 60 s/min * 60 min/hr * 24 hr/day\nconst YEAR_2K_JAN_FIRST_DAY_OFFSET = 730485n; // relative to Jan 1, year 0\n\nconst secondTicks = timestamp - fractionalSecondTicks;\nconst numSeconds = secondTicks / TICKS_PER_SECOND;\nconst numDays = numSeconds / SECONDS_PER_DAY;\n\nconst dayOffset = numDays + YEAR_2K_JAN_FIRST_DAY_OFFSET; // numDays since Jan 1, year 0\n// dayOffset is used as a parameter to GetDates\n")),(0,r.kt)("h3",{id:"where-does-730485-come-from"},"Where does 730,485 come from?"),(0,r.kt)("p",null,"Jan 1, 2000 is 730,485 days after Jan 1, 0000."),(0,r.kt)("p",null,"The difference between Jan 1, 2000 and Jan 1, 0000 is 2000 years.",(0,r.kt)("br",null),"\nWe can approximate how many days this is with following naive calculation:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If we assume a leap year occurs every 4 years, then every 4 years contains 366 + (365 ","*"," 3) => 1461 days."),(0,r.kt)("li",{parentName:"ul"},"1461 days/4-year-group ","*"," 500 4-year-groups => 730,500 days which is pretty close to the correct value.")),(0,r.kt)("p",null,"The thing to remember is that leap years only occur on years which are divisible by 100 if they are also divisible by 400.",(0,r.kt)("br",null),"\nThe years which we shouldn't have counted are 100, 200, 300, 500, 600, 700, 900, 1000, 1100, 1300, 1400, 1500, 1700, 1800, and 1900 (15 total)."),(0,r.kt)("p",null,"730,500 days - 15 days => 730,485 days which is the day offset of Jan 1, 2000 relative to Jan 1, 0000.",(0,r.kt)("br",null)),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Year 0 does not exist for certain calendars, but we treat is as the year before year 1 for the sake of these calculations.")),(0,r.kt)("h2",{id:"getdates"},"GetDates"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"os::GetDates")," is called from within ",(0,r.kt)("inlineCode",{parentName:"p"},"os::OSTicksToCalendarTime"),", and it determines the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"day of the week"),(0,r.kt)("li",{parentName:"ul"},"year"),(0,r.kt)("li",{parentName:"ul"},"day of the year"),(0,r.kt)("li",{parentName:"ul"},"month"),(0,r.kt)("li",{parentName:"ul"},"day of the month")),(0,r.kt)("p",null,"We pass the function two parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," (which was calculated above)"),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"OSCalendarTime")," object which was passed as the 2nd parameter to ",(0,r.kt)("inlineCode",{parentName:"li"},"OSTicksToCalendarTime"),".")),(0,r.kt)("h2",{id:"day-of-the-week"},"Day of the Week"),(0,r.kt)("p",null,"Since Jan 1, 0000 is a Saturday, we know that any day offset which is divisible by 7 is also a Saturday."),(0,r.kt)("p",null,"We find the lowest day offset which is a multiple of 7 and is greater than or equal to ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," parameter. Since that day will always be a Saturday, we can look at the difference between it and ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," to determine which day ours is."),(0,r.kt)("p",null,"For example, if the calculated multiple-of-7 day offset (a Saturday) is 2 greater than ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset"),", we know that ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," is a Thursday."),(0,r.kt)("p",null,"Our final result will be one of the following values:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Value"),(0,r.kt)("th",{parentName:"tr",align:null},"Day of Week"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},"Sunday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"Monday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Tuesday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"Wednesday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"Thursday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"Friday")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"6"),(0,r.kt)("td",{parentName:"tr",align:null},"Saturday")))),(0,r.kt)("p",null,"Below is an approximation of the calculations which are done to determine which day of the week a given ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," is."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const MULHW_NEG_3_OVER_7 = -1840700269n;\n\nconst dayPlus6 = dayOffset + 6n;\n\nconst dayPlus6TimesNeg3Over7 = (MULHW_NEG_3_OVER_7 * dayPlus6) >> 0x20n;\nconst dayPlus6Times4Over7 = dayPlus6 + dayPlus6TimesNeg3Over7;\nconst dayPlus6Over7 = dayPlus6Times4Over7 >> 2n;\nconst nextSeventhDayOffset = dayPlus6Over7 * 7n;\n\nconst dayOfWeek = dayPlus6 - nextSeventhDayOffset;\n// Store dayOfWeek at offset 0x18.\n")),(0,r.kt)("p",null,"This looks complicated, but it is actually doing something simple in a roundabout way to avoid using costly instructions."),(0,r.kt)("p",null,"The straightforward way to do the calculation would be as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"(",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," + 6) / 7 gives 1/7 of (",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," + 6) truncated."),(0,r.kt)("li",{parentName:"ul"},"Multiply that result by 7.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"This will always give a multiple of 7 which is at most ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," + 6 and at least ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset"),"."))),(0,r.kt)("li",{parentName:"ul"},"Compare the product with ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," to determine the day of the week.")),(0,r.kt)("p",null,"We want to avoid dividing by 7 since it takes significantly more clock cycles than doing a right-shift. To handle the division using a right-shift, we need to convert ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," to something which we can divide by a power of 2."),(0,r.kt)("p",null,"We can use 4/7 of (",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," + 6) then right-shift by 2 to get 1/7. But how do we get four sevenths without dividing by 7? We will get negative three sevenths and add it to (",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," + 6). But how do we get negative three sevenths without dividing by 7? This is where the ",(0,r.kt)("inlineCode",{parentName:"p"},"mulhw")," assembly instruction comes into play."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"mulhw")," (Multiply High Word) instruction calculates the most significant 32 bits of the 64-bit product of two 32-bit integers. You could think of this as multiplying two 32-bit integers then right-shifting the result by 32. How can we use this instruction to divide by 7?"),(0,r.kt)("p",null,"Right-shifting by 32 is like dividing by 2 to the power of 32 which is 4,294,967,296. We want dividing by 4,294,967,296 to give us -3/7 of a value. We can represent this with the following ratio:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"X/4,294,967,296")," is equal to ",(0,r.kt)("inlineCode",{parentName:"p"},"-3/7")),(0,r.kt)("p",null,"Solving for X, we get -3 ","*"," 4,294,967,296 / 7 which is -1,840,700,269. This is the constant above which we called MULHW_NEG_3_OVER_7. Now is a good time to review the code block above."),(0,r.kt)("hr",null),(0,r.kt)("p",null,"Some final notes on calculating the day of the week:"),(0,r.kt)("p",null,"Right-shifting a negative number rounds away from zero. When we add this to a larger positive number, the result will be rounded toward 0. When we right-shift a positive number, the result will also be rounded toward 0."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const dayPlus6TimesNeg3Over7 = (MULHW_NEG_3_OVER_7 * dayPlus6) >> 0x20n;\n// ^ rounded away from zero\nconst dayPlus6Times4Over7 = dayPlus6 + dayPlus6TimesNeg3Over7;\n// ^ rounded toward zero\nconst dayPlus6Over7 = dayPlus6Times4Over7 >> 2n;\n// ^ rounded toward zero\nconst nextSeventhDayOffset = dayPlus6Over7 * 7;\n// ^ Will be dayPlus6 at most since dayPlus6Over7 is rounded down.\n\nconst dayOfWeek = dayPlus6 - nextSeventhDayOffset;\n// ^ result is between 0 and 6 inclusive\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"nextSeventhDayOffset")," will be at most ",(0,r.kt)("inlineCode",{parentName:"p"},"dayPlus6")," and at least ",(0,r.kt)("inlineCode",{parentName:"p"},"dayPlus6")," - 6. This means that the resulting ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOfWeek")," will be at least 0 and at most 6, which lines up with the values we want to return."),(0,r.kt)("p",null,"Examples:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If ",(0,r.kt)("inlineCode",{parentName:"li"},"dayPlus6")," is 0 days after a multiple of 7, then it is a Saturday. This means that ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," is 6 days before a Saturday which is a Sunday which is value 0."),(0,r.kt)("li",{parentName:"ul"},"If ",(0,r.kt)("inlineCode",{parentName:"li"},"dayPlus6")," is 1 day after a multiple of 7, then it is a Sunday. This means that ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," is 6 days before a Sunday which is a Monday which is value 1."),(0,r.kt)("li",{parentName:"ul"},"If ",(0,r.kt)("inlineCode",{parentName:"li"},"dayPlus6")," is 2 days after a multiple of 7, then it is a Monday. This means that ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," is 6 days before a Monday which is a Tuesday which is value 2.")),(0,r.kt)("p",null,"As you can see, the difference between ",(0,r.kt)("inlineCode",{parentName:"p"},"dayPlus6")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"nextSeventhDayOffset")," is equal to the value we should return for the day of the week."),(0,r.kt)("h2",{id:"year-and-day-of-the-year"},"Year and Day of the Year"),(0,r.kt)("p",null,"Determining the year and day of the year is a little more challenging since we need to handle leap years. We can approximate the current year with the following calculations:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," / 365 (truncated)"),(0,r.kt)("p",null,"This counts the number of 365 day periods which fit into ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset"),". In reality, the number of years might be less, but it will not be greater. This means we can determine the upper bound for the year."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"738,316 is the ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," for June 10, 2021. If we do ",(0,r.kt)("inlineCode",{parentName:"p"},"738316 / 365")," , we get 2022 which is our upper bound.")),(0,r.kt)("p",null,"We can use the folling algorithm to determine the year:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The upper bound we just determined is the yearCandidate."),(0,r.kt)("li",{parentName:"ol"},"Check if the yearCandidate is the correct year after accounting for leap years."),(0,r.kt)("li",{parentName:"ol"},"If it is not, decrement the yearCandidate by 1 and go back to step 2.")),(0,r.kt)("p",null,"This is pretty straightforward as long as we know how to account for leap years.",(0,r.kt)("br",null),"\nHere are the rules for leap years:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A year is a leap year if it is a multiple of 4 and it is either not a multiple of 100 or it is a multiple of 400."),(0,r.kt)("li",{parentName:"ul"},"Put differently, every 4th year is a leap year unless the year is divisible by 100 but not 400.")),(0,r.kt)("p",null,"Examples of leap years:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"0, 4, 8, 104, 732, 1564, 1600, 2000, 2400.")),(0,r.kt)("p",null,"Examples of years which are not leap years:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"1, 7, 100, 200, 300, 500, 600, 700, 900, 1097, 1883")),(0,r.kt)("p",null,"If the current year is 2000, then 2000 years have completed since year 0 (0, 1, 2 ... 1997, 1998, 1999)."),(0,r.kt)("p",null,"Here are some steps we can use to count the number of those years which were leap years:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If every 4th year was a leap year, then 500 of those 2000 years are leap years."),(0,r.kt)("li",{parentName:"ul"},"We subtract 1 for every 100 years. 2000 / 100 is 20 which leaves us with 480 leap years."),(0,r.kt)("li",{parentName:"ul"},"We add 1 for every 400 years, so 2000 / 400 is 5 which gives us 485 leap years.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"(This result is every 4th year as you might expect, but we make sure to not count these 15 years: 100, 200, 300, 500, 600, 700, 900, 1000, 1100, 1300, 1400, 1500, 1700, 1800, and 1900)")))),(0,r.kt)("p",null,"So at this point, here is what we have:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")),(0,r.kt)("li",{parentName:"ul"},"The yearCandidate"),(0,r.kt)("li",{parentName:"ul"},"The number of leap days which we need to take into account.")),(0,r.kt)("p",null,"We multiply the yearCandidate by 365 to get what the day offset would be for the yearCandidate if each year was 365 days. We then add our calculated number of leap days to this value to get the true day offset of yearCandidate. We compare the day offset of the yearCandidate with ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the day offset of the yearCandidate is greater than ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset"),", then the yearCandidate is too high. We need to decrement it and retry."),(0,r.kt)("li",{parentName:"ul"},"If the day offset of the yearCandidate is less than or equal to ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset"),", then yearCandidate is the correct year (meaning ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOffset")," represents a day which fall in that year).")),(0,r.kt)("p",null,"Once we know the correct year, we can subtract its day offset from ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," to get the day of that year which ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOffset")," falls on. This will be a number with a minimum of 0 for Jan 1 and a maximum of 365 for December 31 on a leap year."),(0,r.kt)("p",null,"Here is how this might look in code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const MULHW_NEG_109_OVER_365 = -1282606671n; // 0xb38cf9b1\nconst MULHW_POINT32 = 1374389535n; // 0x51eb851f\n\nconst dayOffsetTimesNeg109Over365 =\n  (dayOffset * MULHW_NEG_109_OVER_365) >> 0x20n;\nconst dayOffsetTimes256Over365 = dayOffset + dayOffsetTimesNeg109Over365;\n\nlet year = dayOffsetTimes256Over365 >> 8n; // divide by 256\nlet naiveDayOffsetOfYear = year * 365n;\nlet trueDayOffsetOfYear;\n\nwhile (true) {\n  let extraLeapDays;\n\n  if (year >= 1n) {\n    const prevYear = year - 1n;\n    const prevYearTimesPoint32 = (prevYear * MULHW_POINT32) >> 0x20n;\n    const prevYearOver400 = prevYearTimesPoint32 >> 7n; // divide by 128\n    const prevYearOver100 = prevYearTimesPoint32 >> 5n; // divide by 32\n    const yearPlus3Over4 = (year + 3n) >> 2n;\n    const leapDaysWithoutHundreds = yearPlus3Over4 - prevYearOver100;\n    extraLeapDays = leapDaysWithoutHundreds + prevYearOver400;\n  } else {\n    extraLeapDays = 0n;\n  }\n\n  trueDayOffsetOfYear = naiveDayOffsetOfYear + extraLeapDays;\n\n  if (trueDayOffsetOfYear <= dayOffset) {\n    break;\n  }\n\n  year -= 1n;\n  naiveDayOffsetOfYear -= 365n;\n}\n\nconst dayOfTheYear = dayOffset - trueDayOffsetOfYear;\n// Store year at offset 0x14.\n// Store dayOfTheYear at offset 0x1c.\n")),(0,r.kt)("p",null,"Calculations using the MULHW constants are covered in ",(0,r.kt)("a",{parentName:"p",href:"#day-of-the-week"},"Day of the Week"),"."),(0,r.kt)("p",null,"Some of the calculations are done using the previous year because we don't want to count a leap day in the current year. The day offset in the current year will be the same whether it is a leap year or not."),(0,r.kt)("p",null,"For example, assume the yearCandidate is 100. If we divide 100 by 100, we get 1. This would indicate that we counted an extra leap day when we shouldn't have, but this is not the case since we are leaving the current year (year 100) out of the calculations. This problem goes away if we subtract 1 before doing the calculations which divide by 100 and 400."),(0,r.kt)("p",null,"Similarly, we add 3 before calculating the number of leap years we have assuming every 4th year is a leap year. This is to handle the edge case for years near 0. If the current year is 2, then 2 / 4 is 0. This fails to account for year 0 being a leap year. If we add 3 first, then 5 / 4 gives 1 which correctly accounts for year 0."),(0,r.kt)("h2",{id:"month-and-day-of-the-month"},"Month and Day of the Month"),(0,r.kt)("p",null,"The month and day of the month are both determined from the day of the year."),(0,r.kt)("p",null,"First we want to find which month the day of the year is in. Once we know the month, we can subtract the day offset of the month from the day of the year to get the day offset within that month."),(0,r.kt)("p",null,"Note that each month only has 2 possible day offsets depending on if the year is a leap year or not."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Day Offset of Each Month")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Month"),(0,r.kt)("th",{parentName:"tr",align:null},"Not a Leap Year"),(0,r.kt)("th",{parentName:"tr",align:null},"Leap Year"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},"0x000"),(0,r.kt)("td",{parentName:"tr",align:null},"0x000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"0x01f"),(0,r.kt)("td",{parentName:"tr",align:null},"0x01f")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"0x03b"),(0,r.kt)("td",{parentName:"tr",align:null},"0x03c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"0x05a"),(0,r.kt)("td",{parentName:"tr",align:null},"0x05b")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"0x078"),(0,r.kt)("td",{parentName:"tr",align:null},"0x079")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"0x097"),(0,r.kt)("td",{parentName:"tr",align:null},"0x098")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"6"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0b5"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0b6")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"7"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0d4"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0d5")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"8"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0f3"),(0,r.kt)("td",{parentName:"tr",align:null},"0x0f4")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9"),(0,r.kt)("td",{parentName:"tr",align:null},"0x111"),(0,r.kt)("td",{parentName:"tr",align:null},"0x112")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"10"),(0,r.kt)("td",{parentName:"tr",align:null},"0x130"),(0,r.kt)("td",{parentName:"tr",align:null},"0x131")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"11"),(0,r.kt)("td",{parentName:"tr",align:null},"0x14e"),(0,r.kt)("td",{parentName:"tr",align:null},"0x14f")))),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"These values are stored in 2 back-to-back arrays which are each 12 words long at address 803d1048 (US GC).")),(0,r.kt)("p",null,"Here is the algorithm we will use to determine the current month:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Determine if the year is a leap year or not."),(0,r.kt)("li",{parentName:"ol"},"Using the correct ",(0,r.kt)("inlineCode",{parentName:"li"},"DayOffsetOfMonths")," array based on step 1, iterate through it backwards until we reach a month which has a day offset less than or equal to our dayOfTheYear. The array index at which this check passes is the month (0 to 11)."),(0,r.kt)("li",{parentName:"ol"},"Subtract the day offset of that month from our ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOfTheYear")," to get the ",(0,r.kt)("inlineCode",{parentName:"li"},"dayOfTheMonth"),".")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"The month will be between 0 for January and 11 for December.",(0,r.kt)("br",null),"\nThe day of the month will be between 1 and 31.")),(0,r.kt)("p",null,"Here is how ",(0,r.kt)("inlineCode",{parentName:"p"},"month")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"dayOfTheMonth")," are determined:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const MULHW_POINT32 = 1374389535n; // 0x51eb851f\nconst monthDayOffsetsNonLeap = [...]; // static\nconst monthDayOffsetsLeap = [...]; // static\n\nlet isLeapYear = true;\nlet skip400YearCheck = false;\n\nconst yearOver4 = year >> 2n;\nconst prevMultipleOf4Year = yearOver4 * 4n;\n\nif (prevMultipleOf4Year === year) {\n  const yearTimesPoint32 = (prevYear * MULHW_POINT32) >> 0x20n;\n  const yearOver100 = yearTimesPoint32 >> 5n; // divide by 32\n  const prevHundredsYear = yearOver100 * 100n;\n\n  if (prevHundredsYear !== year) {\n    // year is divisible by 4 but not 100, so guaranteed to be a leap year\n    skip400YearCheck = true;\n  }\n}\n\nif (!skip400YearCheck) {\n  const yearTimesPoint32 = (prevYear * MULHW_POINT32) >> 0x20n;\n  const yearOver400 = yearTimesPoint32 >> 7n; // divide by 128\n  const prevFourHundredsYear = yearOver400 * 400n;\n\n    if (prevFourHundredsYear !== year) {\n    isLeapYear = false;\n    }\n}\n\nlet monthDayOffsets;\nif (isLeapYear) {\n  monthDayOffsets = monthDayOffsetsLeap;\n} else {\n  monthDayOffsets = monthDayOffsetsNonLeap;\n}\n\nlet month = 12;\n\nwhile (true) {\n  month -= 1;\n  const monthDayOffset = monthDayOffsets[month];\n  if (dayOfTheYear >= monthDayOffset) {\n    break;\n  }\n}\n\n// Store month (between 0 and 11 inclusive) at offset 0x10.\n\nconst monthDayOffset = monthDayOffsets[month];\nconst dayOffsetOfTheMonth = dayOfTheYear - monthDayOffset;\nconst dayOfTheMonth = dayOffsetOfTheMonth + 1;\n// Store dayOfTheMonth (between 1 and 31) at offset 0xc.\n")),(0,r.kt)("p",null,"Calculations using the MULHW constants are covered in ",(0,r.kt)("a",{parentName:"p",href:"#day-of-the-week"},"Day of the Week"),"."),(0,r.kt)("p",null,"This ends the ",(0,r.kt)("inlineCode",{parentName:"p"},"os::GetDates")," function which determined the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"day of the week"),(0,r.kt)("li",{parentName:"ul"},"year"),(0,r.kt)("li",{parentName:"ul"},"day of the year"),(0,r.kt)("li",{parentName:"ul"},"month"),(0,r.kt)("li",{parentName:"ul"},"day of the month")),(0,r.kt)("h2",{id:"hours-minutes-seconds"},"Hours, Minutes, Seconds"),(0,r.kt)("p",null,"These ones should be pretty straightforward at this point. Once again, calculations using the MULHW constants are covered in ",(0,r.kt)("a",{parentName:"p",href:"#day-of-the-week"},"Day of the Week"),"."),(0,r.kt)("p",null,"We are back in the ",(0,r.kt)("inlineCode",{parentName:"p"},"OSTicksToCalendarTime")," function after finishing ",(0,r.kt)("inlineCode",{parentName:"p"},"GetDates"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const TICKS_PER_SECOND = 40500000n;\nconst SECONDS_PER_DAY = 86400n; // 60 s/min * 60 min/hr * 24 hr/day\nconst MULHW_NEG_28_OVER_60 = -2004318071n; // 0x88888889\n\nconst fractionalSecondTicks = timestamp % TICKS_PER_SECOND;\nconst secondTicks = timestamp - fractionalSecondTicks;\nconst numSeconds = secondTicks / TICKS_PER_SECOND;\nconst secondsOfDay = numSeconds % SECONDS_PER_DAY;\n// ^ number of seconds which have passed in the day the timestamp refers to\n\nconst secondsOfDayTimesNeg28Over60 =\n  (MULHW_NEG_28_OVER_60 * secondsOfDay) >> 0x20n;\nconst secondsOfDayTimes32Over60 = secondsOfDay + secondsOfDayTimesNeg28Over60;\nconst minutesOfDay = secondsOfDayTimes32Over60 >> 5n; // divide by 32\n\nconst minutesOfDayTimesNeg28Over60 =\n  (MULHW_NEG_28_OVER_60 * minutesOfDay) >> 0x20n;\nconst minutesOfDayTimes32Over60 = minutesOfDay + minutesOfDayTimesNeg28Over60;\nconst hours = minutesOfDayTimes32Over60 >> 5n; // divide by 32\n\nconst minutesFromHours = hours * 60n;\n\n// Store hours (0-23) at offset 0x8.\n\nconst secondsFromMinutes = minutesOfDay * 60n;\n\nconst minutes = minutesOfDay - minutesFromHours;\n// Store minutes (0-59) at offset 0x4.\n\nconst seconds = secondsOfDay - secondsFromMinutes;\n// Store seconds (0-59) at offset 0x0.\n")),(0,r.kt)("h2",{id:"closing-thoughts"},"Closing Thoughts"),(0,r.kt)("p",null,"On this page, we didn't go over what happens when the sign bit gets set. From my testing, this function doesn't really handle it that well."),(0,r.kt)("p",null,"In any case, the sign bit won't get set until sometime in the year 9216. Going into any more detail would clutter the page and provide no practical value."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"(Have higher priority things to work on so we only cover the happy path here which is thankfully good enough for the next 7000+ years. - isaac)")),(0,r.kt)("h2",{id:"naming"},"Naming"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"OSTicks comes from the function name."),(0,r.kt)("li",{parentName:"ul"},"OSCalendarTime comes from the Referenced decomp page, and it is also supported by the function name.")),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)(i.Z,{to:"https://github.com/zeldaret/tp/blob/8c2a3ae7eac3483764ccd42f890a1de9cf768538/include/dolphin/os/OS.h#L78",mdxType:"Link"},"TP decomp - OSCalendarTime struct"))))}c.isMDXComponent=!0}}]);